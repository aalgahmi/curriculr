<%= link_to main_app.learn_klass_path(@klass) do %>
  <%= image_tag ui_image_src(@klass.course.poster ? @klass.course.poster.at_url(:md) : nil, '/images/holder-md.png'), 
        class: "hidden-xs hidden-sm #{css_image(:responsive)}" %>
<% end %> 
        
<% enrolled = (@klass.enrolled?(current_student) or staff?(current_user, @klass.course)) %>

<% 
  links = []
  
  links << link_to(t("page.titles.home").html_safe, main_app.learn_klass_path(@klass), 
    class:"#{'active' if controller_name == 'klasses' && action_name == 'show'}")
      
  if @klass.course.config['allow_access_to']['syllabus']
    links << link(:page, :syllabus, main_app.learn_klass_page_path(@klass, @klass.course.syllabus), 
      class:"#{'active' if @page && @page == @klass.course.syllabus}")
  end

  if @klass.course.config['allow_access_to']['lectures']
    if (@klass.open? and ((@klass.allow_enrollment and enrolled) or @klass.previewed)) or (@klass.past? and @klass.lectures_on_closed)
      links << link_to(t("page.titles.outline").html_safe, main_app.learn_klass_lectures_path(@klass), 
        class:"#{'active' if controller_name == 'lectures'}")
    end
  end
  
  if @klass.course.config['allow_access_to']['forums']
    if @klass.allow_enrollment and enrolled 
      if @klass.open? or @klass.past? 
        links << link_to(t("page.titles.forums").html_safe, main_app.learn_klass_forums_path(@klass), 
          class:"#{'active' if %w(forums topics).include?(controller_name)}")
      end 
    end 
  end

  if @klass.course.config['allow_access_to']['assessments']
    if @klass.allow_enrollment and @klass.open? and enrolled
      assessment_links = []

      course_assessments = @klass.course.assessments.where('unit_id is null and ready = TRUE and kind in (:kinds)',      
        :kinds => @klass.course.config["grading"]["distribution"]["assessments"]["course"].keys)
      course_assessments.each do |a|
       assessment_links << ( link_to main_app.learn_klass_assessment_path(@klass, a), 
          class:"#{'active' if %w(assessments attempts).include?(controller_name) && @assessment && @assessment.id == a.id}" do
          "#{content_tag(:i, '', class: 'fa fa-flask')} #{a.name}".html_safe
        end )
      end if course_assessments.any?

      if assessment_links.present?
        links << content_tag(:div , Assessment.model_name.human(count: 3), :class => 'subtitle')
        links += assessment_links
      end
    end
  end
  
  if @klass.allow_enrollment and @klass.open? and enrolled
    survey_links = []
    surveys = @klass.course.assessments.
      where("unit_id is null and ready = TRUE and kind = 'survey'").
      tagged_with(:on_enroll, :exclude => true)

    surveys.each do |survey|
      if survey.can_be_taken?(@klass, current_student)
        survey_links << link_to(survey.name, main_app.new_learn_klass_assessment_attempt_path(@klass, survey))
      end
    end


    if survey_links.present?
      links << content_tag(:div , t('page.titles.surveys'), :class => 'subtitle')
      links += survey_links
    end
  end


  pages_links = []
  pages = enrolled ? @klass.course.non_syllabus_pages(true).to_a : @klass.course.non_syllabus_pages(true, true).to_a  
  if pages.present?
    pages_links << link_to(t("page.titles.pages").html_safe, main_app.learn_klass_pages_path(@klass), 
      class:"#{'active' if controller_name == 'pages' && (@page.nil? || @page != @klass.course.syllabus) }")
  end
    
  books = enrolled ? @klass.course.books : []
  if books.present?
    pages_links << link_to(t('page.titles.attachments').html_safe, main_app.learn_klass_materials_path(@klass), 
      class:"#{'active' if controller_name == 'materials' }")
  end
     
  if pages_links.present?
    links << content_tag(:div , t('page.titles.readings'), :class => 'subtitle')
    links += pages_links
  end

  if @klass.allow_enrollment and enrolled 
    reports_links = []
    if @klass.course.config['allow_access_to']['reports']
      if @klass.open? or @klass.past? 
        reports_links << link_to(t('activerecord.actions.reports').html_safe, main_app.report_learn_klass_path(@klass), 
          class:"#{'active' if controller_name == 'klasses' && action_name == 'report' && params[:student_id].blank?}")
      end 
    end
    
    if !staff?(current_user, @klass.course) and (@klass.open? or @klass.future?) and enrolled
      reports_links << ui_klass_enrollment_action(@klass, :drop)
    end

    if reports_links.present?
      links << content_tag(:div, t('page.titles.progress'), :class => 'subtitle')
      links += reports_links
    end    
  end 
  
  if @klass and staff?(current_user, @klass.course)
    links << content_tag(:div, t('page.titles.for_instructors'), :class => 'subtitle')
    active = if controller_name == 'klasses' && (action_name == 'students' || (action_name == 'report' && params[:student_id]))
      true
    else
      false
    end
    links << link_to(t('page.titles.students').html_safe, main_app.students_learn_klass_path(@klass), 
              class: "#{'active' if active}")

    links << link_to(t('activerecord.actions.dashboard').html_safe, main_app.learn_klass_dashboard_path(@klass),
      class: controller_name == 'dashboard' ? 'active' : nil)
  end
%>
  
<div class="nav-and-social-container">
  <ul>
    <% links.each do |link| %>
      <li><%= link %></li>
    <% end %>
    
    <%= mountable_fragments :klass_side_menu %>
  </ul>
  <div class='text-center social-buttons'>
  <%= ui_facebook_link(@klass) %>
  <%= ui_twitter_link(@klass) %>
  <%= ui_google_plus_link(@klass) %>
  </div>
</div>