<div class="panel-group" id="accordion">
<% units = Unit.open(@klass, current_student).to_a %>
<% units.each_with_index do |unit, i| %>
  <% lectures = Lecture.open_4_students(@klass, unit, current_student).to_a %>
  <%
  expanded = if params[:unit] == unit.id.to_s || lectures.empty?
    true
  else
    (
      lectures.select do |lecture|
        total = if lecture.attendance_data
          data = YAML.load(lecture.attendance_data)
          data[:count] || 0
        else
          0
        end

        total == 0 || lecture.attended  != total
      end
    ).present?
  end
  %>
  <div class="panel panel-inverse klass-lecture">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" data-parent="#accordion" href="#unit-<%= unit.id %>">
          <%= unit.name %>
        </a>
        <% unless expanded %>
          <i class="fa fa-check <%= css_align(:right) %>"></i>
        <% end %>
        <% if @klass.enrolled?(current_student) || staff?(current_user, @klass.course) %>
          <% data = unit.contents(true, true) %>
          <% if data.present? %>
            <%
              attachment_links = []
              data.each do |item|
                case item
                when Material
                  attachment_links << link_to(css_icon(:paperclip, 2) + item.medium.name, item.at_url, :target => '_new')
                when Page
                  attachment_links << link_to(css_icon(:globe, 2) + item.name, learn_klass_page_path(@klass, item))
                when Assessment
                  attachment_links << link_to(css_icon(:flask, 2) + item.name, learn_klass_assessment_path(@klass, item))
                end
              end
            %>

            <%= ui_button_dropdown t('page.titles.attachments'), attachment_links , class: css_button(:default, :xs), align: :right %>
          <% end %>

        <% else %>
          <% ui_klass_enrollment_action(@klass, :enroll, true)  %>
        <% end %>
      </h4>
    </div>

    <div id="unit-<%= unit.id %>" class="panel-collapse collapse <%= 'in' if expanded %>">
      <div class="panel-body">
        <% if false && (@klass.enrolled?(current_student) || KlassEnrollment.staff?(current_user, @klass)) %>
          <% data = unit.contents(true, true) %>
          <% if data.present? %>
            <ul class="nav nav-tabs">
              <% data.each do |item| %>
                <%
                  title = item.kind_of?(Material) ? item.medium.name : item.name
                  popover_attr = {toggle: "popover",  placement: "bottom", content: title, container: 'body' }
                %>
                <li>
                <% case item %>
                <% when Material %>
                  <%= link_to item.at_url, class: "btn-popover", data: popover_attr, :target => '_new' do %>
                    <i class="fa fa-paperclip"></i>
                  <% end %>
                <% when Page %>
                  <%= link_to learn_klass_page_path(@klass, item), class: "btn-popover", data: popover_attr do %>
                    <i class="fa fa-globe"></i>
                  <% end %>
                <% when Assessment %>
                  <%= link_to learn_klass_assessment_path(@klass, item), class: "btn-popover", data: popover_attr do %>
                    <i class="fa fa-flask"></i>
                  <% end %>
                <% end %>
                </li>
              <% end %>
            </ul>
          <% end %>
        <% end %>

        <div class="row">
          <div class="<%= css_columns(12) %> shortenable-text">
            <%= unit.about %>
          </div>
        </div>

        <% unless lectures.to_a.empty? %>
          <table class="table table-condensed">
            <tbody>
              <% lectures.each_with_index do |lecture, j| %>
                <tr>
                  <td>
                    &nbsp;&nbsp;
                    <%= j + 1 %>&nbsp;&nbsp;&nbsp;&nbsp;
                    <%= link_to lecture.name, learn_klass_lecture_path(@klass, lecture) %>
                    <%
                    total = if lecture.attendance_data
                      data = YAML.load(lecture.attendance_data)
                      data[:count] || 0
                    else
                      0
                    end
                    %>
                    <% if total != 0 && lecture.attended == total %>
                      <i class="fa fa-check <%= css_align(:right) %>"></i>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% end %>
      </div>
    </div>
  </div>
<% end %>
</div>
